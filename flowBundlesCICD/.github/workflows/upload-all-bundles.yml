# Multi-Bundle Upload Workflow
#
# This workflow automatically discovers and uploads all bundles in the bundles/ directory.
# It runs automatically on push to main branch and can be triggered manually.
#
# Bundle Discovery:
# - Scans all subdirectories in the bundles/ directory
# - Extracts bundle ID from JSON files using jq
# - Uploads each bundle using uploadBundle.sh
#
# Configuration:
# - Bundles must be located in bundles/ directory at repository root
# - Ensure required GitHub secrets are configured (FLOW_TOKEN, FLOW_HOST)

name: Upload All Bundles

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  upload-all-bundles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout ihub-developer-scripts
        uses: actions/checkout@v4
        with:
          repository: ucroo/ihub-developer-scripts
          path: ihub-developer-scripts

      - name: Install jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          which jq || { echo "jq installation failed"; exit 1; }

      - name: Set up credentials directory
        run: |
          if [ -z "${{ secrets.FLOW_TOKEN }}" ]; then
            echo "ERROR: FLOW_TOKEN secret is required but not set"
            exit 1
          fi
          if [ -z "${{ secrets.FLOW_HOST }}" ]; then
            echo "ERROR: FLOW_HOST secret is required but not set"
            exit 1
          fi

          mkdir -p /home/runner/creds
          echo "${{ secrets.FLOW_TOKEN }}" > /home/runner/creds/ci.token
          echo "${{ secrets.FLOW_HOST }}" > /home/runner/creds/ci.flow
          if [ -n "${{ secrets.API_HOST }}" ]; then
            echo "${{ secrets.API_HOST }}" > /home/runner/creds/ci.api
          fi
          if [ -n "${{ secrets.CURL_ARGS }}" ]; then
            echo "${{ secrets.CURL_ARGS }}" > /home/runner/creds/ci.curl
          fi

      - name: Upload all bundles
        run: |
          set -e  # Exit on any error

          if [ ! -d "bundles" ]; then
            echo "Bundles directory 'bundles' does not exist"
            exit 1
          fi

          cd bundles

          # Find all bundle directories
          for bundle_dir in */; do
            if [ -d "$bundle_dir" ]; then
              echo "Processing bundle directory: $bundle_dir"
              cd "$bundle_dir"

              # Find the JSON bundle file
              json_file=$(find . -maxdepth 1 -name "*.json" | head -1)
              if [ -n "$json_file" ]; then
                # Extract the bundle ID from the JSON file
                bundle_id=$(jq -r '.[0].id // empty' "$json_file")

                if [ -z "$bundle_id" ] || [ "$bundle_id" = "null" ]; then
                  echo "ERROR: Could not find bundle ID in JSON file $json_file"
                  echo "Bundle JSON must contain an 'id' field in the first array element"
                  exit 1
                fi

                echo "Bundle ID: $bundle_id"

                uploadBundle.sh "$bundle_id" ci

                # Check if upload failed by examining response
                if [ -f uploadBundleResponse.txt ]; then
                  if grep -q "400\|error\|failed" uploadBundleResponse.txt; then
                    echo "Upload failed for $bundle_id with error:"
                    cat uploadBundleResponse.txt
                    exit 1
                  fi
                fi

                echo "Successfully uploaded $bundle_id"
              else
                echo "No JSON file found in $bundle_dir, skipping"
              fi

              cd ..
            fi
          done
        env:
          PATH: ${{ github.workspace }}/ihub-developer-scripts:/usr/bin:$PATH
